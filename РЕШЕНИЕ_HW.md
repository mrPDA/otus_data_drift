üßπ –†–ê–ó–ú–ï–©–ï–ù–ò–ï –û–ß–ò–©–ï–ù–ù–´–• –î–ê–ù–ù–´–•

–û—á–∏—â–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—â–µ–Ω—ã –≤ –±–∞–∫–µ—Ç–µ

s3a://otus-additional-bucket-b1gjj3po03aa3m4j8ps5/ml_ready_data_production/

üßπ –≠–¢–ê–ü–´ –û–ß–ò–°–¢–ö–ò –î–ê–ù–ù–´–•
–≠—Ç–∞–ø 1: –ë–∞–∑–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
pythonstep1_df = df.filter(
    col("transaction_id").isNotNull() &
    col("customer_id").isNotNull() & 
    col("terminal_id").isNotNull() &
    col("tx_amount").isNotNull() &
    col("tx_fraud").isNotNull() &
    (col("tx_amount") >= 0.0) &
    (col("tx_fraud").isin(0, 1)) &
    (col("customer_id") >= 0) &
    (col("terminal_id") >= 0) &
    (col("transaction_id") > 0)
)
–£–¥–∞–ª—è–µ—Ç:

‚ùå NULL –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∫–ª—é—á–µ–≤—ã—Ö –ø–æ–ª—è—Ö (ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫–ª–∏–µ–Ω—Ç–∞, —Ç–µ—Ä–º–∏–Ω–∞–ª–∞, —Å—É–º–º—ã, —Ñ–ª–∞–≥–∞ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞)
‚ùå –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —Å—É–º–º—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (tx_amount < 0)
‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ñ–ª–∞–≥–∏ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞ (–Ω–µ 0 –∏ –Ω–µ 1)
‚ùå –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ ID –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ —Ç–µ—Ä–º–∏–Ω–∞–ª–æ–≤
‚ùå –ù—É–ª–µ–≤—ã–µ –∏–ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

–≠—Ç–∞–ø 2: –°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–±—Ä–æ—Å—ã
python# –í—ã—á–∏—Å–ª—è–µ—Ç –∫–≤–∞–Ω—Ç–∏–ª–∏ –∏ IQR
q1, q3 = percentile_approx(tx_amount, 0.25), percentile_approx(tx_amount, 0.75)
p1, p99 = percentile_approx(tx_amount, 0.01), percentile_approx(tx_amount, 0.99)
iqr = q3 - q1

# –ú—è–≥–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
outlier_lower = q1 - 3.0 * iqr if q1 - 3.0 * iqr > p1 else p1
outlier_upper = q3 + 3.0 * iqr if q3 + 3.0 * iqr < p99 else p99
–£–¥–∞–ª—è–µ—Ç:

üìä –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω—ã–µ –≤—ã–±—Ä–æ—Å—ã –ø–æ —Å—É–º–º–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (–∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–∞–≤–∏–ª–æ 3√óIQR)
üìä –ê–Ω–æ–º–∞–ª—å–Ω–æ –±–æ–ª—å—à–∏–µ —Å—É–º–º—ã (–≤—ã—à–µ 99-–≥–æ –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—è + 3√óIQR)
üìä –ê–Ω–æ–º–∞–ª—å–Ω–æ –º–∞–ª—ã–µ —Å—É–º–º—ã (–Ω–∏–∂–µ 1-–≥–æ –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—è - 3√óIQR)

–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç "–º—è–≥–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã" - –Ω–µ —É–¥–∞–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ, –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞—è—Å—å 1-99 –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—è–º–∏.
–≠—Ç–∞–ø 3: –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
pythonstep3_df = step2_df.dropDuplicates(["transaction_id"])
–£–¥–∞–ª—è–µ—Ç:

üîÑ –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º transaction_id

–≠—Ç–∞–ø 4: –õ–æ–≥–∏—á–µ—Å–∫–∞—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
pythonstep4_df = step3_df.filter(
    ~((col("tx_fraud") == 1) & (col("tx_fraud_scenario") == 0)) &
    ~((col("tx_fraud") == 0) & (col("tx_fraud_scenario") > 0))
)
–£–¥–∞–ª—è–µ—Ç:

üö´ –õ–æ–≥–∏—á–µ—Å–∫–∏ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤—ã–µ –∑–∞–ø–∏—Å–∏:

–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –∫–∞–∫ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ (tx_fraud=1), –Ω–æ –±–µ–∑ —Å—Ü–µ–Ω–∞—Ä–∏—è (tx_fraud_scenario=0)
–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ù–ï –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –∫–∞–∫ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–æ (tx_fraud=0), –Ω–æ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º —Å—Ü–µ–Ω–∞—Ä–∏–µ–º –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞ (tx_fraud_scenario>0)



üìä –ê–ù–ê–õ–ò–ó –ö–ê–ß–ï–°–¢–í–ê –î–ê–ù–ù–´–•
–î–µ—Ç–µ–∫—Ü–∏—è –ø—Ä–æ–±–ª–µ–º:
pythonnull_counts = df_sample.select([
    count(when(col(c).isNull() | (col(c) == ""), c)).alias(f"{c}_nulls") 
    for c in df_sample.columns
]).collect()[0].asDict()
–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç:

üîç NULL –∏ –ø—É—Å—Ç—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –∫–∞–∂–¥–æ–π –∫–æ–ª–æ–Ω–∫–µ
üìà –ü—Ä–æ—Ü–µ–Ω—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å—ç–º–ø–ª–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
üìã –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–ø–µ

üéØ –°–ü–ï–¶–ò–§–ò–ö–ê –î–õ–Ø FRAUD DETECTION
–°–∫—Ä–∏–ø—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –ø–æ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤—É –∏ —É—á–∏—Ç—ã–≤–∞–µ—Ç:

–ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É - –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö —Å—É–º–º –∏ ID
–¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –º–µ—Ç–æ–∫ - –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å —Ñ–ª–∞–≥–æ–≤ –º–æ—à–µ–Ω–Ω–∏—á–µ—Å—Ç–≤–∞
–°—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–µ –∞–Ω–æ–º–∞–ª–∏–∏ - –≤—ã–±—Ä–æ—Å—ã –≤ —Å—É–º–º–∞—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
–í—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å timestamp'–æ–≤

üìà –†–ï–ó–£–õ–¨–¢–ê–¢ –û–ß–ò–°–¢–ö–ò
–°–∫—Ä–∏–ø—Ç –≤—ã–≤–æ–¥–∏—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:
Step 1 - Basic validation: 1,500,000 (50,000 removed)
Step 2 - Outlier removal: 1,480,000 (20,000 removed)  
Step 3 - Deduplication: 1,475,000 (5,000 removed)
Step 4 - Fraud logic: 1,470,000 (5,000 removed)
TOTAL CLEANED: 1,470,000 (94.8% retained)